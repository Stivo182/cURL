# cURL для 1С:Предприятие 8

## Использование:

### 1. Установка cURL

#### Windows:
- Установить последнюю [cURL](https://curl.se/windows)
- Указать путь к папке расположения `curl.exe` в перемменную среды `Path` до `C:\Windows\system32`

> [!NOTE]
> Для использования режима эмуляции браузера необходимо наличие сертификата CA `curl-ca-bundle.crt` в папке расположения `curl`
___

### 2. Подключение обработки

#### 1. Использование в составе конфигурации/расширения
1. Добавить обработку в конфигурацию/расширение
2. Создать объект обработки: `CURL = Обработки.cURL.Создать();`

#### 2. Использование в составе другой обработки
1. Добавить обработку в макет другой обработки с именем `cURL`
2. Подключить обработку:
* В модуле формы:
```bsl
ОбъектОбработки = РеквизитФормыВЗначение("Объект");       
ДвоичныеДанные = ОбъектОбработки.ПолучитьМакет("cURL");               
АдресХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
ВнешниеОбработки.Подключить(АдресХранилища,, Ложь);
```
* В модуле объекта:
```bsl    
ДвоичныеДанные = ПолучитьМакет("cURL");               
АдресХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
ВнешниеОбработки.Подключить(АдресХранилища,, Ложь);
```
3. Создать объект обработки: `CURL = ВнешниеОбработки.Создать("cURL",, Ложь);`


> [!IMPORTANT]
> Если путь к папке `curl.exe` не указан в переменной среды `Path`, то необходимо вызвать метод `УказатьИсполняемыйФайл` с указанием пути к исполняемому файлу `curl.exe`
> ```bsl
> CURL.УказатьИсполняемыйФайл("path/to/curl.exe");
> ```
___

## Примеры использования:

### 1. Get методы

#### Отправка HTTP GET запроса без обработки результата
```bsl
CURL.Get("https://example.com/");
```

#### Скачивание файла

```bsl
ПутьКФайлу = CURL.GetFile("ftp://ftp.example.com/file.zip");
```

#### Получение текстовых данных

Вариант 1:
```bsl
Текст = CURL.GetString("https://example.com/");
```

Вариант 2:
```bsl
Текст = CURL
        .Get("ftp://ftp.example.com/README")
        .ОтветКакТекст();
```

#### Получение десериализованного Json

Вариант 1:
```bsl
Json = CURL.GetJson("https://example.com/v1/api");
```

Вариант 2:
```bsl
Json = CURL
        .Get("https://example.com/v1/api")
        .ОтветКакJson();
```

#### Получение двоичных данных

Вариант 1:
```bsl
ДвоичныеДанные = CURL.GetBinaryData("ftp://ftp.example.com/file.zip");
```

Вариант 2:
```bsl
ДвоичныеДанные = CURL
        .Get("https://example.com/file.zip")
        .ОтветКакДвоичныеДанные();
```
___

### 2. Передача файла

Передача файла на FTP сервер:
```bsl
CURL.UploadFile("ftp://ftp.example.com/new.zip", Файл);
```

Передача файла по протоколу HTTP (PUT):
```bsl
CURL.UploadFile("https://example.com/new.html", Файл);
```

> [!NOTE]
> Можно передавать параметр с типами: `Строка`, `ДвоичныеДанные`, `Файл`.
> <br>Тип `Строка` должен содержать путь к файлу на диске или адрес двоичных данных во временном хранилище.

___

### 3. POST (HTTP)

#### Отправка запроса без обработки результата

```bsl
CURL.Post("https://example.com/v1/api");
```

#### Отправка запроса с телом без обработки результата

```bsl
ТелоЗапроса = Новый Структура();
ТелоЗапроса.Вставить("Name", "Jhon");
ТелоЗапроса.Вставить("BirthDate", Дата(2020, 1, 1));
ТелоЗапроса.Вставить("IsEmploee", Истина);

CURL.Post("https://example.com/v1/api", ТелоЗапроса);
```

> [!NOTE]
> В качестве тела запроса можно передавать параметр с типами: `Строка`, `Структура`, `Соответствие`, `ДвоичныеДанные`, `Файл`.
> <br>Тип `Строка` может также содержать путь к файлу на диске или адрес двоичных данных во временном хранилище.

#### Обработка результата как текст

```bsl
Текст = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакТекст();
```

#### Обработка результата как десериализованный Json

```bsl
Json = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакJson();
```

#### Обработка результата как двоичные данные

```bsl
ДвоичныеДанные = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакДвоичныеДанные();
```

#### Обработка результата как путь к файлу

```bsl
ПутьКФайлу = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакПутьФайлу();
```

___

### 4. PUT (HTTP)

Выполнение `PUT` запроса выполняется следующим образом:
```bsl
CURL.Put("https://example.com/put", Данные);
```

> [!NOTE]
> В качестве данных запроса можно передавать параметр с типами: `Строка`, `Структура`, `Соответствие`, `ДвоичныеДанные`, `Файл`.
> <br>Тип `Строка` может также содержать путь к файлу на диске или адрес двоичных данных во временном хранилище.

Также можно использовать метод `UploadFile`
```bsl
CURL.UploadFile("https://example.com/new.html", Файл);
```

___

### 5. Код состояния ответа

Для протоколов `HTTP` и `FTP` реализована возможность получения кода состояния ответа:

```bsl
КодСостояния = CURL
                .Get("https://example.com/")
                .КодСостояния();
```

___

### 6. Работа с HTTP заголовками

#### Установка заголовков запроса

Вариант 1:
```bsl
Заголовки = Новый Соответствие;
Заголовки.Вставить("Accept-Language", "en-US,en;q=0.9");
Заголовки.Вставить("Content-Type", "application/json");
Заголовки.Вставить("Cookie", "name1=value2; name2=value2");

CURL.УстановитьЗаголовки(Заголовки)
```

Вариант 2:
```bsl
CURL.УстановитьЗаголовок("Accept-Language", "en-US,en;q=0.9")
    .УстановитьЗаголовок("Content-Type", "application/json")
    .УстановитьЗаголовок("Cookie", "name1=value2; name2=value2")
```

Вариант 3:
```bsl
Текст = "Accept-Language: en-US,en;q=0.9
        |Content-Type: application/json
        |Cookie: name1=value2; name2=value2";

CURL.УстановитьЗаголовки(Текст)
```

#### Получение заголовков ответа 

Получение всех заголовков ответа:
```bsl
ЗаголовкиОтвета = CURL
        .Get("https://example.com/")
        .ЗаголовкиОтвета();
```

Получение заголовка по имени:
```bsl
CURL.Get("https://example.com/");

ЗначениеЗаголовка1 = CURL.ЗаголовокОтвета("Content-Type");
ЗначениеЗаголовка2 = CURL.ЗаголовокОтвета("Content-Encoding");
```
___

### 7. Аутентификация

Базовая аутентификация:
```bsl
CURL.АутентификацияНаСервере("user", "password")
```

Digest аутентификация:
```bsl
CURL.АутентификацияНаСервереDigest("user", "password")
```
___

### 8. Прокси

Установка прокси:
```bsl
ИнтернетПрокси = Новый ИнтернетПрокси;
ИнтернетПрокси.Установить(Протокол, Адрес, Порт, Логин, Пароль);

CURL.УстановитьПрокси(ИнтернетПрокси)
```
___

### 9. Работа с cookie

При выполнении запроса и получения от сервера новых куки через заголовок ответа `Set-Cookie`, новые куки добавляются к текущим.

#### Отключение автоматического обновления куки:
```bsl
CURL.ОбновлятьКуки(Ложь)
```

#### Принудительное обновление куки:
```bsl
CURL.ОбновитьКуки()
```

#### Получение куки:
```bsl
Куки = CURL.Куки()
```
строкой:
```bsl
КукиСтрокой = CURL.КукиСтрокой()
```

#### Получение только новых куки полученые из заголовка ответа `Set-Cookie`:
```bsl
Куки = CURL.КукиИзОтвета()
```
строкой:
```bsl
КукиСтрокой = CURL.КукиИзОтветаСтрокой()
```

___

### 10. Перенаправление запроса на новый адрес

По умолчанию перенаправление на новый адрес отключено, если сервер вернул ответ с кодом состояния 3XX. Для включения перенаправления необходимо вызвать метод `ПеренаправлятьЗапрос`.

Включение перенаправления:
```bsl
CURL.ПеренаправлятьЗапрос()
```
либо
```bsl
CURL.ПеренаправлятьЗапрос(Истина)
```

Если перенаправление выполняется на другой хост, то по умолчанию данные об аутентификации не передаются. Для передачи необходимо передать `Истина` в качестве второго параметра:
```bsl
CURL.ПеренаправлятьЗапрос(Истина, Истина)
```

Для отключения перенаправления необходимо передать `Ложь` в качестве первого параметра
```bsl
CURL.ПеренаправлятьЗапрос(Ложь)
```
___

### 11. Эмуляция браузера (Chrome)

При включении режима эмуляции браузера дополнительно передаются HTTP заголовки и шифры, использование TLS 1.2 и HTTP/2, запрос на получение сжатого ответа.

Включение эмуляции:
```bsl
CURL.ЭмуляцияБраузера(Истина)
```

Отключение эмуляции:
```bsl
CURL.ЭмуляцияБраузера(Ложь)
```
___

### 12. TLS, SSL шифры (ciphers)

Использование шифров в соединении:
```bsl
CURL.ДобавитьШифры("TLS_AES_128_GCM_SHA256,TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256")
```
Список шифров можно посмотреть по [ссылке](https://curl.se/docs/ssl-ciphers.html)

___

### 13. Использование нереализованных в обработке опций cURL

Добавление опции:

```bsl
CURL.ДобавитьОпцию("--limit-rate", "1000");
```

```bsl
CURL.ДобавитьОпцию("--tlsv1.2");
```

Удаление опции:

```bsl
CURL.УдалитьОпцию("--limit-rate");
```

Очистка всех добавленных опций:

```bsl
CURL.ОчиститьОпции();
```

Все опции утилиты можно посмотреть по [ссылке](https://curl.se/docs/manpage.html)
