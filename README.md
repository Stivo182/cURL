# cURL для 1С:Предприятие 8

## Использование:

### 1. Установка cURL

#### Windows:
- Установить [cURL](https://curl.se/windows)
- Указать `curl` в переменные среды Windows

> [!NOTE]
> Для использования режима эмуляции браузера необходимо наличие сертификата CA `curl-ca-bundle.crt` в папке расположения `curl`
___

### 2. Подключение обработки

#### 1. Использование в составе конфигурации/расширения
1. Добавить обработку в конфигурацию/расширение
2. Создать объект обработки: `CURL = Обработки.cURL.Создать();`

#### 2. Использование в составе другой обработки
1. Добавить обработку в макет другой обработки с именем `cURL`
2. Подключить обработку:
* В модуле формы:
```bsl
ОбъектОбработки = РеквизитФормыВЗначение("Объект");       
ДвоичныеДанные = ОбъектОбработки.ПолучитьМакет("cURL");               
АдресХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
ВнешниеОбработки.Подключить(АдресХранилища,, Ложь);
```
* В модуле объекта:
```bsl    
ДвоичныеДанные = ПолучитьМакет("cURL");               
АдресХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
ВнешниеОбработки.Подключить(АдресХранилища,, Ложь);
```
3. Создать объект обработки: `CURL = ВнешниеОбработки.Создать("cURL",, Ложь);`


> [!IMPORTANT]
> Если в переменных среды операционной системы отсутствует `curl`, то необходимо вызвать метод `УказатьИсполняемыйФайл` с указанием пути исполняемому файлу
> ```bsl
> CURL.УказатьИсполняемыйФайл("path/to/curl.exe");
> ```
___

## Примеры использования:

### 1. GET Запросы

#### Отправка запроса без обработки результата
```bsl
CURL.Get("https://example.com/");
```

#### Получение результата как текст

Вариант 1:
```bsl
Текст = CURL.GetString("https://example.com");
```

Вариант 2:
```bsl
Текст = CURL
        .Get("https://example.com")
        .ОтветКакТекст();
```

#### Получение десериализованного Json

Вариант 1:
```bsl
Json = CURL.GetJson("https://example.com/v1/api");
```

Вариант 2:
```bsl
Json = CURL
        .Get("https://example.com/v1/api")
        .ОтветКакJson();
```

#### Получение результата как двоичные данные

- Вариант 1:
```bsl
ДвоичныеДанные = CURL.GetBinaryData("https://example.com/file.zip");
```

- Вариант 2:
```bsl
ДвоичныеДанные = CURL
        .Get("https://example.com/file.zip")
        .ОтветКакДвоичныеДанные();
```

#### Получение результата как путь к файлу

```bsl
ПутьКФайлу = CURL
        .Get("https://example.com/")
        .ОтветКакПутьФайлу();
```
___

### 2. POST Запросы

#### Отправка запроса без обработки результата

```bsl
CURL.Post("https://example.com/v1/api");
```

#### Отправка запроса с телом без обработки результата

```bsl
ТелоЗапроса = Новый Структура();
ТелоЗапроса.Вставить("Name", "Jhon");
ТелоЗапроса.Вставить("BirthDate", Дата(2020, 1, 1));
ТелоЗапроса.Вставить("IsEmploee", Истина);

CURL.Post("https://example.com/v1/api", ТелоЗапроса);
```

> [!NOTE]
> В качестве тела запроса можно передавать параметр с типами: `Строка`, `Структура`, `Соответствие`, `ДвоичныеДанные`, `Файл`
> <br> и `Строка` хранящий адрес двоичных данных во временном хранилище

#### Обработка результата как текст

```bsl
Текст = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакТекст();
```

#### Обработка результата как десериализованный Json

```bsl
Json = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакJson();
```

#### Обработка результата как двоичные данные

```bsl
ДвоичныеДанные = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакДвоичныеДанные();
```

#### Обработка результата как путь к файлу

```bsl
ПутьКФайлу = CURL
        .Post("https://example.com/v1/api")
        .ОтветКакПутьФайлу();
```

___

### 3. Работа с HTTP заголовками

#### Установка заголовков запроса

Вариант 1:
```bsl
Заголовки = Новый Соответствие;
Заголовки.Вставить("Accept-Language", "en-US,en;q=0.9");
Заголовки.Вставить("Content-Type", "application/json");
Заголовки.Вставить("Cookie", "name1=value2; name2=value2");

CURL.УстановитьЗаголовки(Заголовки)
```

Вариант 2:
```bsl
CURL.УстановитьЗаголовок("Accept-Language", "en-US,en;q=0.9")
    .УстановитьЗаголовок("Content-Type", "application/json")
    .УстановитьЗаголовок("Cookie", "name1=value2; name2=value2")
```

Вариант 3:
```bsl
Текст = "Accept-Language: en-US,en;q=0.9
        |Content-Type: application/json
        |Cookie: name1=value2; name2=value2";

CURL.УстановитьЗаголовки(Текст)
```

#### Получение заголовков ответа 

Получение всех заголовков ответа:
```bsl
ЗаголовкиОтвета = CURL
        .Get("https://example.com/")
        .ЗаголовкиОтвета();
```

Получение заголовка по имени:
```bsl
CURL.Get("https://example.com/");

ЗначениеЗаголовка1 = CURL.ЗаголовокОтвета("Content-Type");
ЗначениеЗаголовка2 = CURL.ЗаголовокОтвета("Content-Encoding");
```
___

### 4. Аутентификация

Базовая аутентификация:
```bsl
CURL.АутентификацияНаСервере("user", "password")
```

Digest аутентификация:
```bsl
CURL.АутентификацияНаСервереDigest("user", "password")
```
___

### 5. Прокси

Установка прокси:
```bsl
ИнтернетПрокси = Новый ИнтернетПрокси;
ИнтернетПрокси.Установить(Протокол, Адрес, Порт, Логин, Пароль);

CURL.УстановитьПрокси(ИнтернетПрокси)
```
___

### 6. Работа с cookie

При выполнении запроса и получения от сервера новых куки через заголовок ответа `Set-Cookie`, новые куки добавляются к текущим.

#### Отключение автоматического обновления куки:
```bsl
CURL.ОбновлятьКуки(Ложь)
```

#### Принудительное обновление куки:
```bsl
CURL.ОбновитьКуки()
```

#### Получение куки:
```bsl
Куки = CURL.Куки()
```
строкой:
```bsl
КукиСтрокой = CURL.КукиСтрокой()
```

#### Получение только новых куки полученые из заголовка ответа `Set-Cookie`:
```bsl
Куки = CURL.КукиИзОтвета()
```
строкой:
```bsl
КукиСтрокой = CURL.КукиИзОтветаСтрокой()
```

___

### 7. Перенаправление запроса на новый адрес

По умолчанию перенаправление на новый адрес отключено, если сервер вернул ответ с кодом состояния 3XX. Для включения перенаправления необходимо вызвать метод `ПеренаправлятьЗапрос`.

Включение перенаправления:
```bsl
CURL.ПеренаправлятьЗапрос()
```
либо
```bsl
CURL.ПеренаправлятьЗапрос(Истина)
```

Если перенаправление выполняется на другой хост, то по умолчанию данные об аутентификации не передаются. Для передачи необходимо передать `Истина` в качестве второго параметра:
```bsl
CURL.ПеренаправлятьЗапрос(Истина, Истина)
```

Для отключения перенаправления необходимо передать `Ложь` в качестве первого параметра
```bsl
CURL.ПеренаправлятьЗапрос(Ложь)
```
___

### 8. Эмуляция браузера (Chrome)

При включении режима эмуляции браузера дополнительно передаются HTTP заголовки и шифры, использование TLS 1.2 и HTTP/2, запрос на получение сжатого ответа.

```bsl
CURL.ЭмуляцияБраузера()
```
___

### 9. SSL шифры (ciphers)

Использование шифров в соединении:
```bsl
CURL.ДобавитьШифры("TLS_AES_128_GCM_SHA256,TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256")
```
Список шифров можно посмотреть по [ссылке](https://curl.se/docs/ssl-ciphers.html)
